<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trang qu·∫£n tr·ªã HFTA</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <script type="module">
    // Import c√°c h√†m b·∫°n c·∫ßn t·ª´ SDK v9
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js"; // *** TH√äM IMPORT ***

    // Your web app's Firebase configuration (L·∫•y t·ª´ file index.html c·ªßa b·ªë)
    const firebaseConfig = {
        apiKey: "AIzaSyBfu2qVSLiTIaf2xUwVUw0AzROtE5YS8Tc",
        authDomain: "hfta-a1cdc.firebaseapp.com",
        projectId: "hfta-a1cdc",
        storageBucket: "hfta-a1cdc.firebasestorage.app", // Gi·ªØ nguy√™n
        messagingSenderId: "715501206681",
        appId: "1:715501206681:web:5bb1a8076e8828d0accc08"
    };

    // Initialize Firebase v9
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app); // *** KH·ªûI T·∫†O DATABASE ***

    // G√°n v√†o global window ƒë·ªÉ script.js (d·∫°ng compat v8) c√≥ th·ªÉ d√πng
    window.firebaseV9Services = { auth, db, app };
    window.firebaseV8Config = firebaseConfig;

    // ƒê√¢y l√† "ng∆∞·ªùi g√°c c·ªïng" d√πng v9
    onAuthStateChanged(auth, user => {
        if (!user) {
            console.log("Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ index.html");
            window.location.href = 'index.html';
        } else {
            console.log("ƒê√£ ƒëƒÉng nh·∫≠p v9:", user.email, user.uid);
            // Ch·ªâ load script sau khi DOM ho√†n to√†n s·∫µn s√†ng V√Ä user ƒë√£ ƒëƒÉng nh·∫≠p
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                loadDashboardScripts(user);
            } else {
                document.addEventListener('DOMContentLoaded', () => loadDashboardScripts(user));
            }
        }
    });

    // H√†m n√†y s·∫Ω t·∫£i c√°c script th∆∞ vi·ªán V√Ä script.js c·ªßa b·∫°n
    async function loadDashboardScripts(user) { // *** NH·∫¨N USER ***
        console.log("DOM ready, starting script load...");
        const scripts = [
            "https://cdn.jsdelivr.net/npm/chart.js", // Chart.js
            "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js", // jsPDF
            // T·∫£i b·∫£n 'compat' (v8)
            "https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js",
            "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js",
            "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js", // *** TH√äM D√íNG N√ÄY ***
            "script.js" // T·∫£i script ch√≠nh c·ªßa b·∫°n CU·ªêI C√ôNG
        ];

        async function loadScript(src) {
             return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => { console.log(`Loaded: ${src}`); resolve(); }; // Log khi load xong
                script.onerror = (e) => { console.error(`Error loading: ${src}`, e); reject(e); };
                document.body.appendChild(script); // Th√™m v√†o body
            });
        }

       try {
            // T·∫£i tu·∫ßn t·ª±
            await loadScript(scripts[0]); // Chart.js
            await loadScript(scripts[1]); // jsPDF
            await loadScript(scripts[2]); // firebase-app-compat

            // Kh·ªüi t·∫°o app compat
            if (!firebase.apps.length) { // Ch·ªâ kh·ªüi t·∫°o n·∫øu ch∆∞a c√≥
                firebase.initializeApp(window.firebaseV8Config);
                console.log("Firebase v8 compat initialized.");
            } else { console.log("Firebase v8 compat already initialized."); }

            await loadScript(scripts[3]); // auth-compat
            await loadScript(scripts[4]); // *** FIRESTORE COMPAT ***
            await loadScript(scripts[5]); // *** SCRIPT.JS ***

            console.log("ƒê√£ t·∫£i t·∫•t c·∫£ script c·ªßa dashboard.");

            // G·ªçi h√†m runDashboard t·ª´ script.js v√† truy·ªÅn user v√†o
            if (typeof runDashboard === 'function') {
                runDashboard(user); // *** TRUY·ªÄN USER V√ÄO ƒê√ÇY ***
            } else { console.error("L·ªói: Kh√¥ng t√¨m th·∫•y h√†m runDashboard() trong script.js sau khi t·∫£i xong."); }
        } catch (error) {
            console.error("L·ªói nghi√™m tr·ªçng khi t·∫£i script dashboard:", error);
            alert("L·ªói t·∫£i t√†i nguy√™n trang web. Vui l√≤ng ki·ªÉm tra Console (F12) v√† th·ª≠ l·∫°i.");
        }
    }
  </script>

</head>
<body>

  <header class="navbar">
    <div class="nav-left">
      <img src="logo.png" alt="Logo" class="nav-logo" id="app-logo" />
      <h1 id="app-title">Hanoi Center for Financial and Technology Analytics</h1>
    </div>
    <div class="nav-right"> <nav class="nav-menu">
            <button class="tab active" data-tab="overview">T·ªïng quan</button>
            <button class="tab" data-tab="quant">Quant AI</button>
            <button class="tab" data-tab="sentiment">Sentiment AI</button>
            <button class="tab" data-tab="risk">R·ªßi ro</button>
            <button class="tab" data-tab="macro">Vƒ© m√¥</button>
            <button class="tab" data-tab="advisor">C·ªë v·∫•n</button>
            <button class="tab" data-tab="console">AI Console</button>
            <button class="tab" data-tab="report">B√°o c√°o</button>
            <button class="tab" data-tab="mail"><i class="fa-solid fa-envelope"></i> H·ªôp th∆∞</button>
        </nav>
        <div class="user-profile-simple">
            <span id="user-email-display">ƒêang t·∫£i...</span>
            <button id="logout-button-simple"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </div>
  </header>

  <main id="content">

    <section id="overview" class="tab-content active">
      <h2>üìä T·ªïng quan h·ªá th·ªëng</h2>
      <div class="cards">
        <div class="card">
          <h3 id="live-btc-price-title">Gi√° BTC hi·ªán t·∫°i</h3>
          <p class="big-number" id="live-btc-price-value">$67,430</p>
          <small id="live-last-updated">+1.24% trong 24h</small>
        </div>
        <div class="card">
          <h3 id="live-sentiment-title">ƒê·ªô tin c·∫≠y t·ªïng h·ª£p</h3>
          <p class="big-number" id="live-sentiment-value">82%</p>
          <small id="live-sentiment-source">ƒê√°nh gi√° b·ªüi 4 Ban AI</small>
        </div>
        <div class="card">
          <h3 id="live-recommendation-title">Khuy·∫øn ngh·ªã cu·ªëi</h3>
          <p class="big-number" id="live-recommendation-value">LONG 20%</p>
          <small id="live-recommendation-reason">Theo Kelly Criterion</small>
        </div>
      </div>
    </section>
    <section id="quant" class="tab-content">
      <h2>üìà Quant AI ‚Äì Ph√¢n t√≠ch k·ªπ thu·∫≠t</h2>
      <p id="quant-summary">AI nh·∫≠n ƒë·ªãnh xu h∆∞·ªõng tƒÉng trung h·∫°n, RSI = 58, MA50 > MA200.</p>
      <div class="chart-box"> <canvas id="quantChart"></canvas> </div>
    </section>
    <section id="sentiment" class="tab-content">
      <h2>üí¨ Sentiment AI ‚Äì T√¢m l√Ω th·ªã tr∆∞·ªùng</h2>
      <p id="sentiment-summary">Twitter: FOMO nh·∫π, Reddit: Trung l·∫≠p. ƒêi·ªÉm c·∫£m x√∫c: <strong>63/100</strong></p>
      <div class="card sentiment-meter">
         <div class="fill" id="sentiment-fill" style="width: 63%"></div>
         <span id="sentiment-score-text">63/100</span>
      </div>
    </section>
    <section id="risk" class="tab-content">
      <h2>‚ö†Ô∏è Risk AI ‚Äì Qu·∫£n tr·ªã r·ªßi ro</h2>
      <ul id="risk-list">
        <li>ƒê·ªô bi·∫øn ƒë·ªông hi·ªán t·∫°i: <b>3.2%</b></li>
        <li>Max Drawdown d·ª± ki·∫øn: <b>-8.6%</b></li>
        <li>Khuy·∫øn ngh·ªã v·ªën t·ªëi ƒëa: <b>25%</b></li>
      </ul>
    </section>
    <section id="macro" class="tab-content">
      <h2>üåç Macro AI ‚Äì Chu k·ª≥ & D√≤ng ti·ªÅn</h2>
      <p>DXY gi·∫£m nh·∫π, SP500 ƒëi ngang, On-chain inflow gi·∫£m 4%. T√≠n hi·ªáu ‚ÄúRisk-On‚Äù.</p>
      <img src="https://www.tradingview.com/x/bC6TgR9u/" alt="macro chart" class="demo-img" />
    </section>
    <section id="advisor" class="tab-content">
      <h2>üß† Advisor LLM ‚Äì Ph·∫£n bi·ªán & T∆∞ duy</h2>
      <div class="chat-box">
        <div class="msg ai">Quant AI: X√°c su·∫•t tƒÉng 68%.</div>
        <div class="msg ai">Sentiment AI: T√¢m l√Ω ƒëang c·∫£i thi·ªán.</div>
        <div class="msg human">B·∫°n: Xem l·∫°i correlation gi·ªØa DXY v√† BTC tu·∫ßn n√†y.</div>
        <div class="msg ai">Advisor: Correlation -0.45 ‚áí h·ªó tr·ª£ tƒÉng gi√°.</div>
      </div>
    </section>
    <section id="console" class="tab-content">
      <h2>üíª AI Console</h2>
      <textarea id="aiInput" placeholder="Nh·∫≠p l·ªánh ho·∫∑c c√¢u h·ªèi cho AI..."></textarea>
      <button id="runAI">G·ª≠i</button>
      <div id="aiOutput"></div>
    </section>
    <section id="report" class="tab-content">
      <h2>üìë B√°o c√°o & Xu·∫•t PDF</h2>
      <p>B·∫•m n√∫t b√™n d∆∞·ªõi ƒë·ªÉ t·∫°o b√°o c√°o PDF.</p>
      <button id="exportPDF">Xu·∫•t b√°o c√°o</button>
    </section>

    <section id="mail" class="tab-content">
      <div class="mail-layout-v3"> <div class="mail-sidebar card">
          <button id="mail-compose-new-btn-desktop" class="mail-compose-btn"><i class="fa-solid fa-pencil"></i> So·∫°n th∆∞</button>
          <ul class="mail-folders">
            <li id="folder-inbox" class="mail-folder active" data-folder="inbox"><i class="fa-solid fa-inbox"></i> H·ªôp th∆∞ ƒë·∫øn</li>
            <li id="folder-sent" class="mail-folder" data-folder="sent"><i class="fa-solid fa-paper-plane"></i> Th∆∞ ƒë√£ g·ª≠i</li>
          </ul>
        </div>

        <div class="mail-list-container card">
          <div class="mail-mobile-folder-selector">
              <button class="folder-btn active" data-folder="inbox"><i class="fa-solid fa-inbox"></i> ƒê·∫øn</button>
              <button class="folder-btn" data-folder="sent"><i class="fa-solid fa-paper-plane"></i> ƒê√£ g·ª≠i</button>
          </div>
          <div class="mail-list-header" id="mail-list-header">H·ªôp th∆∞ ƒë·∫øn</div> <div id="mail-list" class="mail-list">
            <p class="loading-text">ƒêang t·∫£i th∆∞...</p>
          </div>
        </div>

        <div class="mail-reader-container card">
          <div id="mail-reader-placeholder" class="mail-reader-empty">
            <i class="fa-regular fa-envelope-open"></i>
            <p>Ch·ªçn m·ªôt th∆∞ ƒë·ªÉ xem chi ti·∫øt</p>
          </div>
          <div id="mail-reader-content" style="display: none;"> <button id="mail-reader-back-btn" class="mail-reader-back-btn" style="display: none;"><i class="fa-solid fa-arrow-left"></i></button> <div class="mail-reader-header">
                <h3 id="reader-subject"></h3>
                <p><strong id="reader-from-label">T·ª´:</strong> <span id="reader-from"></span></p>
                <p><strong>ƒê·∫øn:</strong> <span id="reader-to"></span></p>
                <p><small id="reader-timestamp"></small></p>
             </div>
             <hr>
             <div id="reader-body" class="mail-reader-body"></div>
          </div>
        </div>

        <div id="mail-compose-modal" class="mail-modal">
          <div class="mail-modal-content">
            <div class="mail-modal-header">
              <h3>Th∆∞ m·ªõi</h3>
              <button id="mail-compose-close" class="mail-close-btn">&times;</button>
            </div>
            <div class="mail-modal-body">
              <input type="email" id="mail-to" placeholder="G·ª≠i ƒë·∫øn (email)">
              <input type="text" id="mail-subject" placeholder="Ch·ªß ƒë·ªÅ">
              <textarea id="mail-body" placeholder="N·ªôi dung..."></textarea>
              <button id="mail-send-btn">G·ª≠i</button>
              <p id="mail-status"></p>
            </div>
          </div>
        </div>

        <button id="mail-compose-fab" class="mail-compose-fab"><i class="fa-solid fa-plus"></i></button>

      </div>
    </section>
    </main>

  <footer>
    <p>Hanoi Center for Financial and Technology Analytics ¬© 2025 | Designed by Thanh Le</p>
    <p>Li√™n h·ªá: <a href="facebook.com">Facebook</a></p>
  </footer>

</body>
</html>
